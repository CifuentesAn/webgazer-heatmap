<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Panel de Eye-tracking (WebGazer + Heatmap KDE)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0d10; --panel:#111418; --muted:#1a1f25; --text:#e9eef5; --sub:#b8c0cc;
    --brand:#49a6ff; --ok:#22c55e; --warn:#f59e0b; --card:#0f1318; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0c10,#0c1117);color:var(--text);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .app{display:flex;min-height:100vh}
  aside{width:340px;background:linear-gradient(180deg,#0d1117,#0b0f14);border-right:1px solid #10151c;padding:18px;position:sticky;top:0;height:100vh;overflow:auto}
  main{flex:1;display:flex;flex-direction:column}
  h1{font-size:18px;margin:0 0 12px;font-weight:700}
  h2{font-size:13px;margin:18px 0 8px;color:var(--sub);text-transform:uppercase;letter-spacing:.12em}
  .card{background:var(--card);border:1px solid #121820;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:var(--shadow)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #1e2630;background:#121922;color:#e9eef5;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.brand{background:linear-gradient(180deg,#1b84ff,#0f6be6);border-color:#1870f2}
  .btn.ok{background:linear-gradient(180deg,#27d17c,#0fb368);border-color:#10b981}
  .btn.warn{background:linear-gradient(180deg,#fbbf24,#f59e0b);border-color:#f59e0b;color:#0b0d10}
  .btn.ghost{background:transparent;border-color:#26303b}
  .muted{color:var(--sub);font-size:12px}
  input[type="file"],input[type="number"],input[type="text"]{width:100%;background:#0f141a;color:#e9eef5;border:1px solid #1e2630;border-radius:10px;padding:8px 10px}
  label{display:block;font-size:12px;color:var(--sub);margin-bottom:6px}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{display:flex;gap:10px;align-items:center;background:#0c1218;border:1px solid #141c25;padding:8px;border-radius:10px}
  .item img{width:44px;height:44px;object-fit:cover;border-radius:8px;border:1px solid #1b2430}
  .item .meta{flex:1;min-width:0}
  .item .meta .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .stage-wrap{flex:1;display:flex;gap:12px;padding:16px}
  .stage{flex:1;display:grid;place-items:center;background:#0b0f14;border-left:1px solid #0f151d;position:relative;overflow:hidden}
  .canvas-layer{position:absolute;inset:0}
  #heatCanvas,#pointsCanvas{pointer-events:none}
  .toolbar{position:sticky;top:0;background:linear-gradient(180deg,#0e141b,#0c1016);border-bottom:1px solid #111922;padding:10px 14px;display:flex;gap:10px;align-items:center}
  .spacer{flex:1}

  /* Bot√≥n pantalla completa */
  .fs-btn{
    position:absolute; top:10px; right:10px; z-index:6;
    background:rgba(0,0,0,.45); border:1px solid #2a3340; color:#e9eef5;
    border-radius:10px; padding:6px 10px; cursor:pointer; font-weight:600;
    backdrop-filter: blur(2px);
  }
  .fs-btn:hover{ background:rgba(0,0,0,.6); }

  /* Bloqueador de rat√≥n durante estudio */
  .mouse-blocker{
    position:absolute; inset:0; z-index:7; background:transparent;
  }
  .hide-cursor{ cursor: none; }

  .calib-overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:5}
  .calib-grid{position:absolute;inset:0;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr)}
  .calib-dot{width:16px;height:16px;border-radius:50%;background:#1b84ff;box-shadow:0 0 0 6px rgba(24,112,242,.2),0 0 0 14px rgba(24,112,242,.07);margin:auto;cursor:crosshair}
  video#webgazerVideoFeed,canvas#webgazerVideoCanvas,canvas#webgazerFaceOverlay,canvas#webgazerFaceFeedbackBox{display:none !important}
</style>
</head>
<body>
<div class="app">
  <aside>
    <h1>Panel de control</h1>
    <div class="card">
      <h2>1 ¬∑ Im√°genes del estudio</h2>
      <label>Sube 1 o varias im√°genes (JPG/PNG)</label>
      <input id="fileInput" type="file" accept="image/*" multiple>
      <div class="muted" style="margin-top:6px">Puedes reordenarlas y borrar las que no uses.</div>
      <div id="imageList" class="list" style="margin-top:10px"></div>
    </div>

    <div class="card">
      <h2>2 ¬∑ Par√°metros</h2>
      <div class="row">
        <div style="flex:1">
          <label>Duraci√≥n por imagen (s)</label>
          <input id="trialSeconds" type="number" min="1" max="120" value="6">
        </div>
        <div style="flex:1">
          <label>Radio heatmap (px)</label>
          <input id="hmRadius" type="number" min="10" max="240" value="60">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <label>Intensidad heatmap (0.05‚Äì2.0)</label>
          <input id="hmIntensity" type="text" inputmode="decimal" value="1.0">
        </div>
        <div style="flex:1">
          <label>FPS muestreo (Hz)</label>
          <input id="sampleHz" type="number" min="1" max="60" value="30">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <label><input id="togglePoints" type="checkbox" checked> Mostrar puntos</label>
      </div>
    </div>

    <div class="card">
      <h2>3 ¬∑ Flujo</h2>
      <div class="row">
        <button id="btnStartCam" class="btn brand">Iniciar c√°mara</button>
        <button id="btnCalibrate" class="btn">Calibrar</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnRun" class="btn ok">Iniciar estudio</button>
        <button id="btnStop" class="btn warn">Detener</button>
      </div>
      <div class="muted" style="margin-top:6px">Atajos: Q=Calibrar, W=Iniciar, E=Detener.</div>
    </div>

    <div class="card">
      <h2>Exportar</h2>
      <div class="row"><button id="btnExportCSV" class="btn">Exportar CSV</button></div>
      <div class="row" style="margin-top:8px">
        <button id="btnSaveHeat" class="btn">Guardar Heatmap PNG</button>
        <button id="btnSaveComposite" class="btn">Heatmap + Imagen</button>
      </div>
      <div class="muted" style="margin-top:8px">Los exportes usan s√≥lo datos locales; no se sube nada.</div>
    </div>
  </aside>

  <main>
    <div class="toolbar">
      <div class="row"><span class="muted">Estado:&nbsp;</span><span id="statusText">Listo</span></div>
      <div class="spacer"></div>
      <div class="row muted"><span>Imagen:</span><span id="imgIndex">‚Äì</span><span>Tiempo:</span><span id="timer">0.0s</span><span>Muestras:</span><span id="sampleCount">0</span></div>
    </div>
    <div class="stage-wrap">
      <div class="stage" id="stage">
        <canvas id="imageCanvas" class="canvas-layer"></canvas>
        <canvas id="heatCanvas" class="canvas-layer"></canvas>
        <canvas id="pointsCanvas" class="canvas-layer"></canvas>

        <!-- Bloqueador de rat√≥n (activo s√≥lo durante el estudio) -->
        <div id="mouseBlocker" class="mouse-blocker" hidden></div>

        <!-- Bot√≥n pantalla completa -->
        <button id="btnFullscreen" class="fs-btn" title="Pantalla completa">‚õ∂</button>

        <div class="calib-overlay" id="calibOverlay">
          <div class="calib-grid" id="calibGrid"></div>
        </div>
      </div>
    </div>
  </main>
</div>

<script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
<script>
/* ===== util ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1200); }
function num(v, d=0){ const n=parseFloat(String(v).replace(',','.')); return Number.isFinite(n)?n:d; }

/* ===== estado ===== */
let images=[], currentIndex=-1, collecting=false, sampleInterval=null, startTime=0;
const pointsByImage = new Map();
const params = { trialSeconds:6, hmRadius:60, hmIntensity:1.0, sampleHz:30 };

/* ===== canvas ===== */
const imageCanvas = $('#imageCanvas'), pointsCanvas = $('#pointsCanvas'), heatCanvas = $('#heatCanvas'), stageEl = $('#stage');
const iCtx = imageCanvas.getContext('2d'), pCtx = pointsCanvas.getContext('2d'), hCtx = heatCanvas.getContext('2d');
function resizeCanvases(){
  const r = stageEl.getBoundingClientRect();
  for(const c of [imageCanvas, pointsCanvas, heatCanvas]){ c.width=Math.max(320, r.width|0); c.height=Math.max(240, r.height|0); }
  if(currentIndex>=0) drawCurrentImage();
  drawOverlays();
}
addEventListener('resize', resizeCanvases);

/* ===== carga im√°genes ===== */
$('#fileInput').addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files||[]);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const url = URL.createObjectURL(f);
    const img = new Image(); await new Promise(res=>{ img.onload=res; img.src=url; });
    const item = { id: crypto.randomUUID(), name:f.name, url, imgEl:img, w:img.naturalWidth, h:img.naturalHeight };
    images.push(item); pointsByImage.set(item.id, []);
  }
  renderImageList();
  if(currentIndex===-1 && images.length){ currentIndex=0; drawCurrentImage(); }
});
function renderImageList(){
  const list = $('#imageList'); list.innerHTML='';
  images.forEach((it, idx)=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<img src="${it.url}"><div class="meta"><div class="name">${it.name}</div><div class="muted">${it.w}√ó${it.h}px</div></div>
    <div class="actions"><button class="btn ghost" title="Arriba">‚Üë</button><button class="btn ghost" title="Abajo">‚Üì</button><button class="btn ghost" title="Ver">üëÅ</button><button class="btn ghost" title="Borrar">‚úï</button></div>`;
    const [up,down,view,del]=el.querySelectorAll('button');
    up.onclick=()=>{ if(idx>0){ [images[idx-1],images[idx]]=[images[idx],images[idx-1]]; renderImageList(); } };
    down.onclick=()=>{ if(idx<images.length-1){ [images[idx+1],images[idx]]=[images[idx],images[idx+1]]; renderImageList(); } };
    view.onclick=()=>{ currentIndex=idx; drawCurrentImage(); };
    del.onclick=()=>{ if(confirm('¬øEliminar esta imagen?')){ URL.revokeObjectURL(it.url); images.splice(idx,1); renderImageList(); if(currentIndex>=images.length) currentIndex=images.length-1; drawCurrentImage(); } };
    list.appendChild(el);
  });
}

/* ===== dibujo (sin HM en vivo) ===== */
function drawCurrentImage(){
  iCtx.clearRect(0,0,imageCanvas.width,imageCanvas.height);
  if(currentIndex<0 || !images[currentIndex]) return;
  const img = images[currentIndex].imgEl;
  const W=imageCanvas.width, H=imageCanvas.height;
  const s = Math.min(W/img.naturalWidth, H/img.naturalHeight);
  const w=(img.naturalWidth*s)|0, h=(img.naturalHeight*s)|0;
  const dx=((W-w)/2)|0, dy=((H-h)/2)|0;
  iCtx.imageSmoothingQuality='high'; iCtx.drawImage(img,dx,dy,w,h);
  images[currentIndex]._drawRect = {dx,dy,drawW:w,drawH:h, scale:s};
  $('#imgIndex').textContent = `${currentIndex+1}/${images.length}`;
}
function drawOverlays(){
  pCtx.clearRect(0,0,pointsCanvas.width,pointsCanvas.height);
  hCtx.clearRect(0,0,heatCanvas.width,heatCanvas.height);
  if(currentIndex<0) return;
  if(!$('#togglePoints').checked) return;
  const img = images[currentIndex], rect = img?._drawRect; if(!rect) return;
  const pts = pointsByImage.get(img.id)||[];
  pCtx.save(); pCtx.fillStyle='rgba(255,255,255,.9)';
  for(const pt of pts){
    const x = rect.dx + pt.x*rect.drawW, y = rect.dy + pt.y*rect.drawH;
    pCtx.beginPath(); pCtx.arc(x,y,2,0,Math.PI*2); pCtx.fill();
  }
  pCtx.restore();
}

/* ===== heatmap KDE ===== */
function colorLUT(t){
  const stops = [
    [0.00,[0,32,128]],[0.20,[0,140,255]],[0.40,[0,200,120]],[0.60,[255,230,0]],[0.80,[255,140,0]],[1.00,[230,30,0]]
  ];
  for(let i=0;i<stops.length-1;i++){
    const [p0,c0]=stops[i],[p1,c1]=stops[i+1];
    if(t>=p0 && t<=p1){ const u=(t-p0)/(p1-p0); return [
      Math.round(c0[0]*(1-u)+c1[0]*u),
      Math.round(c0[1]*(1-u)+c1[1]*u),
      Math.round(c0[2]*(1-u)+c1[2]*u)
    ]; }
  }
  return stops.at(-1)[1];
}
function gaussianKernel1D(sigma){
  sigma=Math.max(0.8,sigma);
  const r = Math.max(1, Math.round(sigma*3));
  const size = 2*r+1, k = new Float32Array(size); const s2 = 2*sigma*sigma; let sum=0;
  for(let i=-r,idx=0;i<=r;i++,idx++){ const v=Math.exp(-(i*i)/s2); k[idx]=v; sum+=v; }
  for(let i=0;i<size;i++) k[i]/=sum; return {k,r};
}
function blurH(src, dst, W, H, k, r){
  for(let y=0;y<H;y++){
    const o=y*W;
    for(let x=0;x<W;x++){
      let acc=0; for(let i=-r;i<=r;i++){ const xi=Math.min(W-1,Math.max(0,x+i)); acc+=src[o+xi]*k[i+r]; }
      dst[o+x]=acc;
    }
  }
}
function blurV(src, dst, W, H, k, r){
  for(let y=0;y<H;y++){
    for(let x=0;x<W;x++){
      let acc=0; for(let i=-r;i<=r;i++){ const yi=Math.min(H-1,Math.max(0,y+i)); acc+=src[yi*W+x]*k[i+r]; }
      dst[y*W+x]=acc;
    }
  }
}
function renderHeatmapKDE(normPoints, w, h, radius=60, intensity=1.0){
  const maxSide = 512;
  const scale = Math.max(1, Math.ceil(Math.max(w,h) / maxSide));
  const W = Math.max(8, Math.floor(w/scale));
  const H = Math.max(8, Math.floor(h/scale));

  const grid = new Float32Array(W*H);
  for(const p of normPoints){
    const x = Math.min(W-1, Math.max(0, Math.floor(p.x*W)));
    const y = Math.min(H-1, Math.max(0, Math.floor(p.y*H)));
    grid[y*W+x] += 1;
  }

  const sigma = Math.max(0.8, (radius/scale) * 0.5);
  const {k,r} = gaussianKernel1D(sigma);
  const tmp = new Float32Array(W*H);
  const blur1 = new Float32Array(W*H);
  blurH(grid,tmp,W,H,k,r);
  blurV(tmp,blur1,W,H,k,r);

  for(let i=0;i<blur1.length;i++) blur1[i] *= Math.max(0.05, intensity);

  const vals = Array.from(blur1).filter(v=>v>0);
  if(!vals.length){ const empty=document.createElement('canvas'); empty.width=w; empty.height=h; return empty; }
  vals.sort((a,b)=>a-b);
  const q = (arr,p) => arr[Math.min(arr.length-1, Math.max(0, Math.floor(p*arr.length)))];
  let pLow = q(vals,0.20), pHigh = q(vals,0.995);
  if(pHigh <= pLow){ pLow = Math.max(0, pHigh*0.5); pHigh = pLow + 1e-6; }
  const den = pHigh - pLow, gammaC=0.90, gammaA=0.92;

  const small = document.createElement('canvas'); small.width=W; small.height=H;
  const sctx = small.getContext('2d', {willReadFrequently:true});
  const im = sctx.createImageData(W,H), od = im.data;
  for(let i=0;i<blur1.length;i++){
    let v = (blur1[i]-pLow)/den; if(v<0)v=0; if(v>1)v=1;
    const vc=Math.pow(v,gammaC); const [R,G,B]=colorLUT(vc);
    const off=i*4; od[off]=R; od[off+1]=G; od[off+2]=B; od[off+3]=Math.round(255*Math.pow(v,gammaA));
  }
  sctx.putImageData(im,0,0);
  const out = document.createElement('canvas'); out.width=w; out.height=h;
  const octx = out.getContext('2d'); octx.imageSmoothingEnabled=true; octx.drawImage(small,0,0,w,h);
  return out;
}

/* ===== c√°mara / muestreo ===== */
const statusText = $('#statusText');
async function startCamera(){
  statusText.textContent='Solicitando c√°mara...';
  try{
    await webgazer.setGazeListener(()=>{}).begin();
    webgazer.params.showVideoPreview = true;
    webgazer.params.showFaceOverlay = false;
    webgazer.params.showFaceFeedbackBox = false;
    try{ webgazer.showPredictionPoints(false); }catch{}
    // Clave: que WebGazer no guarde puntos de rat√≥n fuera de la calibraci√≥n
    try{ webgazer.removeMouseEventListeners?.(); }catch{}
    statusText.textContent='C√°mara lista';
  }catch(e){
    console.error(e);
    alert('No se pudo iniciar la c√°mara. Usa HTTPS y acepta permisos.');
    statusText.textContent='Error al iniciar c√°mara';
  }
}
function viewportToImageNorm(x,y){
  const rect = images[currentIndex]?._drawRect; if(!rect) return null;
  if(x<rect.dx||y<rect.dy||x>rect.dx+rect.drawW||y>rect.dy+rect.drawH) return null;
  return { x:(x-rect.dx)/rect.drawW, y:(y-rect.dy)/rect.drawH };
}
let ema=null; const ALPHA=0.35;
function startSampling(){
  const hz = Math.max(1, Math.min(60, num($('#sampleHz').value,30)));
  const period = 1000/hz;
  if(sampleInterval) clearInterval(sampleInterval);
  sampleInterval = setInterval(async ()=>{
    const pred = await webgazer.getCurrentPrediction();
    if(!pred) return;
    ema = ema ? {x:ALPHA*pred.x+(1-ALPHA)*ema.x, y:ALPHA*pred.y+(1-ALPHA)*ema.y} : {x:pred.x, y:pred.y};
    const norm = viewportToImageNorm(ema.x, ema.y);
    if(!norm) return;
    const t = performance.now()-startTime;
    const arr = pointsByImage.get(images[currentIndex].id);
    arr.push({t,x:norm.x,y:norm.y});
    $('#sampleCount').textContent = String(arr.length);
    if($('#togglePoints').checked) drawOverlays();
  }, period);
}
function stopSampling(){ if(sampleInterval){ clearInterval(sampleInterval); sampleInterval=null; } }

/* ===== bloqueo de rat√≥n ===== */
const mouseBlocker = $('#mouseBlocker');
['mousemove','mousedown','mouseup','click','dblclick','pointerdown','pointerup','contextmenu','wheel']
  .forEach(ev => mouseBlocker.addEventListener(ev, e => { e.stopPropagation(); e.preventDefault(); }, true));
function setMouseBlocked(on){
  mouseBlocker.hidden = !on;
  if(on){ stageEl.classList.add('hide-cursor'); }
  else { stageEl.classList.remove('hide-cursor'); }
}

/* ===== calibraci√≥n ===== */
const calibOverlay = $('#calibOverlay'), calibGrid = $('#calibGrid');
function buildCalibrationGrid(){ calibGrid.innerHTML=''; for(let i=0;i<9;i++){ const d=document.createElement('div'); d.className='calib-dot'; calibGrid.appendChild(d); } }
async function runCalibration(){
  if(!images.length){ alert('Primero sube im√°genes.'); return; }
  try{ webgazer.clearData(); }catch{}
  ema=null;
  setMouseBlocked(false); // permitir clics en los puntos
  calibOverlay.style.display='flex';
  buildCalibrationGrid();
  const dots = Array.from(calibGrid.children);
  const need=6;
  dots.forEach(d=>{
    d.dataset.count='0';
    d.onclick=()=>{
      const c=+d.dataset.count+1; d.dataset.count=String(c);
      const r=d.getBoundingClientRect(); const sx=r.left+r.width/2, sy=r.top+r.height/2;
      for(let k=0;k<3;k++){ try{ webgazer.recordScreenPosition(sx,sy,'click'); }catch{} }
      d.style.background = c>=need ? '#22c55e' : '#1b84ff';
    };
  });
  await new Promise(res=>{
    const iv=setInterval(()=>{ if(dots.every(d=>+d.dataset.count>=need)){ clearInterval(iv); res(); } },300);
  });
  calibOverlay.style.display='none';
  statusText.textContent='Calibrado';
}

/* ===== estudio ===== */
async function runStudy(){
  if(!images.length){ alert('Sube al menos una imagen.'); return; }
  if(!webgazer.isReady()){ alert('Primero inicia la c√°mara.'); return; }
  for(const it of images) pointsByImage.set(it.id, []);
  currentIndex=0; drawCurrentImage();
  const trial = Math.max(1, num($('#trialSeconds').value,6));
  collecting=true; statusText.textContent='Grabando...';
  startTime=performance.now();

  // Desactivar cualquier escucha de rat√≥n y bloquearlo visualmente
  try{ webgazer.removeMouseEventListeners?.(); }catch{}
  setMouseBlocked(true);

  startSampling();

  const t0=performance.now(), timerEl=$('#timer');
  for(let i=0; i<images.length && collecting; i++){
    currentIndex=i; drawCurrentImage();
    const end=performance.now()+trial*1000;
    while(collecting && performance.now()<end){
      timerEl.textContent=((performance.now()-t0)/1000).toFixed(1)+'s';
      await sleep(50);
    }
  }
  collecting=false; stopSampling(); statusText.textContent='Finalizado';
  setMouseBlocked(false);
  drawOverlays();
}
function stopStudy(){ collecting=false; stopSampling(); statusText.textContent='Detenido'; setMouseBlocked(false); }

/* ===== exportes ===== */
function exportCSV(){
  const rows=[['image','t_ms','x_norm','y_norm']];
  for(const it of images){
    const arr=pointsByImage.get(it.id)||[];
    for(const p of arr) rows.push([it.name, Math.round(p.t), p.x.toFixed(5), p.y.toFixed(5)]);
  }
  const blob=new Blob([rows.map(r=>r.join(',')).join('\n')], {type:'text/csv;charset=utf-8'});
  downloadBlob(blob,'gaze_data.csv');
}
function saveHeatmapPNG(){
  if(currentIndex<0){ alert('No hay imagen activa.'); return; }
  const img=images[currentIndex], rect=img._drawRect; if(!rect) return;
  const pts=pointsByImage.get(img.id)||[]; if(!pts.length){ alert('No hay datos.'); return; }
  const hm = renderHeatmapKDE(pts, rect.drawW, rect.drawH, num($('#hmRadius').value,60), num($('#hmIntensity').value,1.0));
  const c=document.createElement('canvas'); c.width=rect.drawW; c.height=rect.drawH;
  c.getContext('2d').drawImage(hm,0,0);
  c.toBlob(b=>downloadBlob(b, `heatmap_${sanitize(img.name)}.png`));
}
function saveCompositePNG(){
  if(currentIndex<0){ alert('No hay imagen activa.'); return; }
  const img=images[currentIndex], rect=img._drawRect; if(!rect) return;
  const pts=pointsByImage.get(img.id)||[]; if(!pts.length){ alert('No hay datos.'); return; }
  const hm = renderHeatmapKDE(pts, rect.drawW, rect.drawH, num($('#hmRadius').value,60), num($('#hmIntensity').value,1.0));
  const c=document.createElement('canvas'); c.width=rect.drawW; c.height=rect.drawH;
  const cx=c.getContext('2d');
  cx.drawImage(images[currentIndex].imgEl,0,0,rect.drawW,rect.drawH);
  cx.globalAlpha=.85; cx.drawImage(hm,0,0);
  c.toBlob(b=>downloadBlob(b, `composite_${sanitize(img.name)}.png`));
}
function sanitize(n){ return n.replace(/[^a-z0-9_\-\.]+/gi,'_'); }

/* ===== pantalla completa ===== */
function toggleFullscreen(){
  const el = stageEl;
  if (!document.fullscreenElement){
    el.requestFullscreen?.().catch(()=>{});
  } else {
    document.exitFullscreen?.();
  }
}
$('#btnFullscreen').onclick = toggleFullscreen;
document.addEventListener('fullscreenchange', ()=>{ resizeCanvases(); });

/* ===== atajos (Q/W/E) ===== */
document.addEventListener('keydown', (ev)=>{
  const tag = (ev.target && ev.target.tagName)||'';
  if (ev.ctrlKey||ev.metaKey||ev.altKey) return;
  if (tag === 'INPUT' || tag === 'TEXTAREA' || ev.target.isContentEditable) return;
  const k = ev.key.toLowerCase();
  if (k==='q'){ buildCalibrationGrid(); runCalibration(); }
  else if (k==='w'){ runStudy(); }
  else if (k==='e'){ stopStudy(); }
});

/* ===== UI ===== */
$('#btnStartCam').onclick=startCamera;
$('#btnCalibrate').onclick=()=>{ buildCalibrationGrid(); runCalibration(); };
$('#btnRun').onclick=runStudy;
$('#btnStop').onclick=stopStudy;
$('#btnExportCSV').onclick=exportCSV;
$('#btnSaveHeat').onclick=saveHeatmapPNG;
$('#btnSaveComposite').onclick=saveCompositePNG;
$('#trialSeconds').oninput=e=>params.trialSeconds=num(e.target.value,6);
$('#hmRadius').oninput=e=>params.hmRadius=num(e.target.value,60);
$('#hmIntensity').oninput=e=>params.hmIntensity=num(e.target.value,1.0);
$('#sampleHz').oninput=e=>params.sampleHz=num(e.target.value,30);

/* ===== arranque ===== */
addEventListener('load', ()=>{ resizeCanvases(); });
</script>
</body>
</html>
